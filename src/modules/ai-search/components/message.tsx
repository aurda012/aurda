'use client';

import { StreamableValue, useStreamableValue } from 'ai/rsc';
import { MemoizedReactMarkdown } from './ui/markdown';
import rehypeExternalLinks from 'rehype-external-links';
import remarkGfm from 'remark-gfm';
import remarkMath from 'remark-math';
import rehypeKatex from 'rehype-katex';
import 'katex/dist/katex.min.css';

export function BotMessage({ content }: { content: StreamableValue<string> }) {
  const [data, error, pending] = useStreamableValue(content);

  // Currently, sometimes error occurs after finishing the stream.
  if (error) return <div>Error</div>;

  //modify the content to render LaTeX equations
  const processedData = preprocessLaTeX(data || '');

  return (
    <MemoizedReactMarkdown
      // @ts-ignore
      rehypePlugins={[[rehypeExternalLinks, { target: '_blank' }], rehypeKatex]}
      remarkPlugins={[remarkGfm, remarkMath]}
      className="prose prose-neutral prose-a:text-accent-foreground/50 dark:text-white"
    >
      {processedData}
    </MemoizedReactMarkdown>
  );
}

// Preprocess LaTeX equations to be rendered by KaTeX
// ref: https://github.com/remarkjs/react-markdown/issues/785
const preprocessLaTeX = (content: string) => {
  const blockProcessedContent = content.replace(
    /\\\[([\s\S]*?)\\\]/g,
    (_, equation) => `$$${equation}$$`
  );
  const inlineProcessedContent = blockProcessedContent.replace(
    /\\\(([\s\S]*?)\\\)/g,
    (_, equation) => `$${equation}$`
  );
  return inlineProcessedContent;
};
